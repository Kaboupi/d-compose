name: Docker Image Check

on:
  pull_request:
    branches:
      - master
  # push:
  #   branches:
  #     - master

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:latest
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      - name: Build Docker images
        run: |
          docker compose -f docker-compose.yaml build

      - name: Run airflow-init
        run: |
          docker compose -f docker-compose.yaml up airflow-init
          docker compose -f docker-compose.yaml logs airflow-init
        
      - name: Start all services
        run: |
          docker compose -f docker-compose.yaml up -d

      - name: Start healthchecks
        run: |
          declare -a services=(
            "kaboupi-af-webserver"
            "kaboupi-af-scheduler"
            "kaboupi-af-worker"
            "kaboupi-af-postgres"
            "kaboupi-clickhouse"
            "kaboupi-postgres"
            "kaboupi-nifi"
            "kaboupi-kafka"
            "kaboupi-zookeeper"
            "kaboupi-grafana"
          )

          # SET BASE TIMEOUT FOR HEALTHCHECK

          timeout=180
          cur_time=$(date +"%H:%M:%S")

          check_service() {
            local service=$1
            local start_time=$(date +%s)

            while true; do
              if ! docker ps -a --format '{{.Names}}' | grep -q "^${service}$"; then
                echo -e "\nService $service does not exist! Exiting..."
                exit 1
              fi

              health_state=$(docker inspect -f '{{.State.Health.Status}}' "${service}")
              current_time=$(date +%s)
              elapsed_time=$((current_time - start_time))
              echo "[$cur_time] - Waiting for $service to be healthy...($health_state, $elapsed_time / $timeout)"
                
              if [ "$health_state" == "healthy" ]; then
                echo "[$cur_time] - Service $service is healthy!"
                return 0
              fi

              if [ "$health_state" == "unhealthy" ]; then
                echo -e "[$cur_time] - ERROR!\nService $service is unhealthy! Exiting...\n$(docker logs $service -n 30)"
                exit 1
              fi

              if [ $elapsed_time -ge $timeout ]; then
                echo "[$cur_time] - Timeout reached for $service. Exiting..."
                exit 1
              fi

              sleep 5
            done
          }

          for service in "${services[@]}"; do
            check_service "$service" &
          done

          wait

      - name: Clean up
        run: |
          docker compose -f docker-compose.yaml down
